{
  "title": "ttyny",
  "description": "Schema to define stories for the `ttyny` game engine.",
  "type": "object",
  "required": ["items", "locations", "endings"],
  "additionalProperties": false,
  "properties": {
    "items": {
      "$ref": "#/$defs/Items",
      "description": "All item definitions available in the story."
    },
    "locations": {
      "$ref": "#/$defs/Locations",
      "description": "All location definitions available in the story."
    },
    "endings": {
      "type": "array",
      "description": "Possible endings of the story. They are evaluated in order, from first to last. The first one to have all requirements satisfied will trigger.",
      "items": { "$ref": "#/$defs/Ending" }
    }
  },
  "$defs": {
    "NonEmptyString": {
      "type": "string",
      "minLength": 1
    },
    "ActionList": {
      "type": "array",
      "description": "Each user input in `ttyny` gets labeled as one of these actions. They are used to identify transition triggers.",
      "items": {
        "enum": ["use", "move", "examine", "take", "drop"]
      },
      "minItems": 1
    },
    "Items": {
      "type": "array",
      "items": { "$ref": "#/$defs/Item" }
    },
    "Locations": {
      "type": "array",
      "items": { "$ref": "#/$defs/Location" }
    },
    "ObjectSpecifier": {
      "type": "string",
      "description": "Identifies an object by its name or name.state_index. If no state index is provided, an object in any state will be matched.",
      "pattern": "^.+(\\.\\d+){0,1}"
    },
    "RequirementTuples": {
      "type": "array",
      "items": { "$ref": "#/$defs/ObjectSpecifier" },
      "minItems": 1
    },
    "Requirements": {
      "type": "object",
      "description": "Requirements that must be satisfied to perform a transition or reach an ending. Each field may be null (no constraint) or a specific constraint object.",
      "properties": {
        "inventory": {
          "description": "Met when the specified items are in the inventory.",
          "oneOf": [{ "type": "null" }, { "$ref": "#/$defs/RequirementTuples" }]
        },
        "items": {
          "description": "Met when the specified items in the world are in the given state.",
          "oneOf": [{ "type": "null" }, { "$ref": "#/$defs/RequirementTuples" }]
        },
        "locations": {
          "description": "Met when the specified locations in the world are in the given state.",
          "oneOf": [{ "type": "null" }, { "$ref": "#/$defs/RequirementTuples" }]
        },
        "turns": {
          "description": "Met when the number of turns is greater than specified amount.",
          "oneOf": [{ "type": "null" }, { "type": "number", "minimum": 1 }]
        },
        "current_location": {
          "description": "Met if the current location is the specified one.",
          "oneOf": [{ "type": "null" }, { "$ref": "#/$defs/ObjectSpecifier" }]
        }
      },
      "required": [
        "inventory",
        "items",
        "locations",
        "turns",
        "current_location"
      ],
      "additionalProperties": false
    },
    "Transition": {
      "type": "object",
      "description": "A state change triggered by performing one of the listed actions when requirements are met.",
      "required": ["actions", "from", "to", "requirements"],
      "additionalProperties": false,
      "properties": {
        "actions": { "$ref": "#/$defs/ActionList" },
        "from": {
          "type": "integer",
          "minimum": 0,
          "description": "Index of the originating description/state."
        },
        "to": {
          "type": "integer",
          "minimum": 0,
          "description": "Index of the target description/state."
        },
        "requirements": { "$ref": "#/$defs/Requirements" }
      }
    },
    "Item": {
      "type": "object",
      "description": "An item is an object the player can interact with. It represents a physical object like a lamp or an apple.",
      "required": [
        "name",
        "type",
        "descriptions",
        "transitions",
        "collectible",
        "readable"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "description": "Unique identifier of the item. It must be human-readable, as it will be shown to the users.",
          "$ref": "#/$defs/NonEmptyString"
        },
        "type": {
          "const": "item",
          "description": "Fixed discriminator to identify items from locations."
        },
        "descriptions": {
          "type": "array",
          "description": "Descriptions of the possible states of this item. There are as many descriptions as states. They should provide enough context for the language model to craft a story around them.",
          "items": { "$ref": "#/$defs/NonEmptyString" },
          "minItems": 1
        },
        "transitions": {
          "type": "array",
          "items": { "$ref": "#/$defs/Transition" },
          "description": "Possible state transitions for the item. Set to empty if the item does not change state (you should have only one item in descriptions in that case).",
          "default": []
        },
        "collectible": {
          "type": "boolean",
          "description": "True if the item can be added to the player's inventory."
        },
        "readable": {
          "type": "boolean",
          "description": "True if upon inspection the item reveals its description verbatim."
        }
      }
    },
    "Location": {
      "type": "object",
      "description": "A location is a game object representing a place the user can visit.",
      "required": [
        "name",
        "type",
        "descriptions",
        "transitions",
        "items",
        "exits"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "description": "Unique identifier of the location. It must be human-readable, as it will be shown to the users.",
          "$ref": "#/$defs/NonEmptyString"
        },
        "type": {
          "const": "location",
          "description": "Fixed discriminator to identify items from locations."
        },
        "descriptions": {
          "type": "array",
          "description": "Descriptions of the possible states of this location. There are as many descriptions as states. They should provide enough context for the language model to craft a story around them.",
          "items": { "$ref": "#/$defs/NonEmptyString" },
          "minItems": 1
        },
        "transitions": {
          "type": "array",
          "items": { "$ref": "#/$defs/Transition" },
          "description": "Possible state transitions for the location. Set to empty if the location does not change state (you should have only one item in descriptions in that case).",
          "default": []
        },
        "items": {
          "type": "array",
          "description": "Names of items initially present at this location.",
          "items": { "$ref": "#/$defs/NonEmptyString" },
          "default": []
        },
        "exits": {
          "type": "array",
          "description": "Names of other locations reachable from here.",
          "items": { "$ref": "#/$defs/NonEmptyString" },
          "default": []
        }
      }
    },
    "Ending": {
      "type": "object",
      "description": "Terminal game state reached when requirements are satisfied.",
      "required": ["state", "reason", "requirements"],
      "additionalProperties": false,
      "properties": {
        "state": {
          "type": "string",
          "enum": ["win", "lose"],
          "description": "Outcome classification."
        },
        "reason": {
          "description": "Context provided to the language model to narrate the end of the story.",
          "$ref": "#/$defs/NonEmptyString"
        },
        "requirements": { "$ref": "#/$defs/Requirements" }
      }
    }
  }
}
